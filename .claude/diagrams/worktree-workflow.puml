@startuml worktree-workflow
!theme plain

title Worktreeä¸¦åˆ—å®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - Git Worktree + Claude Codeçµ±åˆ

|CoordinatorAgent|
start

:npm run agents:parallel:exec\n--issues=270,271,272 --concurrency=3;

:Issueæƒ…å ±ã‚’GitHub APIã‹ã‚‰å–å¾—;
note right
  - Issue #270
  - Issue #271
  - Issue #272
end note

:ã‚¿ã‚¹ã‚¯åˆ†è§£ãƒ»DAGæ§‹ç¯‰;
note right
  **DAGæ§‹ç¯‰**
  Level 0: [task-270, task-271, task-272]
  â†’ 3ã¤ã®ã‚¿ã‚¹ã‚¯ã¯ä¾å­˜é–¢ä¿‚ãªã—
  â†’ ä¸¦è¡Œå®Ÿè¡Œå¯èƒ½
end note

:ä¸¦è¡Œåº¦ç®—å‡º;
note right
  concurrency = min(
    ç‹¬ç«‹ã‚¿ã‚¹ã‚¯æ•°: 3,
    æŒ‡å®šå€¤: 3,
    æœ€å¤§ä¸¦è¡Œæ•°: 5
  ) = 3
end note

|Main Directory|

:ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œè¨ˆç”»ä½œæˆ;

:ExecutionPlanä¿å­˜\n(.ai/parallel-reports/);

fork
  |Worktree #1|
  :Worktreeä½œæˆ\n.worktrees/issue-270/;

  :ãƒ–ãƒ©ãƒ³ãƒä½œæˆ\nfeature/issue-270;

  :Claude Codeèµ·å‹•\n(Worktree #1å†…);

  :ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿\n.claude/agents/prompts/codegen-agent-prompt.md;
  note right
    **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°**
    WORKTREE_PATH: .worktrees/issue-270
    BRANCH_NAME: feature/issue-270
    TASK_ID: task-270
    ISSUE_NUMBER: 270
  end note

  :è¦ä»¶åˆ†æ\n(5åˆ†);

  :ã‚³ãƒ¼ãƒ‰å®Ÿè£…\n(30-60åˆ†);
  note right
    **å®Ÿè£…å†…å®¹**
    - TypeScript strict mode
    - BaseAgentãƒ‘ã‚¿ãƒ¼ãƒ³
    - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ (Vitest)
    - JSDocã‚³ãƒ¡ãƒ³ãƒˆ
  end note

  :ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\nnpm test;

  if (ãƒ†ã‚¹ãƒˆæˆåŠŸ?) then (yes)
    :Git commit;
    note right
      feat: implement task-270

      ğŸ¤– Generated with Claude Code
      Co-Authored-By: Claude <noreply@anthropic.com>
    end note
  else (no)
    :ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²;
    :Worktreeä¿æŒ\n(ãƒ‡ãƒãƒƒã‚°ç”¨);
    stop
  endif

  :JSONå‡ºåŠ›ç”Ÿæˆ;
  note right
    {
      "status": "success",
      "taskId": "task-270",
      "filesCreated": 3,
      "testResults": {
        "passed": 15,
        "failed": 0
      }
    }
  end note

fork again
  |Worktree #2|
  :Worktreeä½œæˆ\n.worktrees/issue-271/;

  :ãƒ–ãƒ©ãƒ³ãƒä½œæˆ\nfeature/issue-271;

  :Claude Codeèµ·å‹•\n(Worktree #2å†…);

  :ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿\n.claude/agents/prompts/review-agent-prompt.md;

  :ESLintå®Ÿè¡Œ\n(5åˆ†);

  :TypeScriptå‹ãƒã‚§ãƒƒã‚¯\n(5åˆ†);

  :ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³\n(5åˆ†);
  note right
    - Secretæ¤œå‡º
    - è„†å¼±æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ
    - npm audit
  end note

  :å“è³ªã‚¹ã‚³ã‚¢ç®—å‡º;
  note right
    base_score: 100
    - ESLintã‚¨ãƒ©ãƒ¼: -20ç‚¹/ä»¶
    - TypeScriptã‚¨ãƒ©ãƒ¼: -30ç‚¹/ä»¶
    - Criticalè„†å¼±æ€§: -40ç‚¹/ä»¶
    åˆæ ¼ãƒ©ã‚¤ãƒ³: 80ç‚¹ä»¥ä¸Š
  end note

  if (å“è³ªã‚¹ã‚³ã‚¢ â‰¥ 80ç‚¹?) then (yes)
    :Git commit;
  else (no)
    :ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³\nâ†’ TechLead;
    stop
  endif

  :JSONå‡ºåŠ›ç”Ÿæˆ;

fork again
  |Worktree #3|
  :Worktreeä½œæˆ\n.worktrees/issue-272/;

  :ãƒ–ãƒ©ãƒ³ãƒä½œæˆ\nfeature/issue-272;

  :Claude Codeèµ·å‹•\n(Worktree #3å†…);

  :ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿\n.claude/agents/prompts/deployment-agent-prompt.md;

  :ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ\nnpm run build\n(2åˆ†);

  if (ãƒ“ãƒ«ãƒ‰æˆåŠŸ?) then (yes)
    :ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\nnpm test\n(3åˆ†);
  else (no)
    :ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³\nâ†’ TechLead;
    stop
  endif

  if (ãƒ†ã‚¹ãƒˆæˆåŠŸ?) then (yes)
    :Firebaseãƒ‡ãƒ—ãƒ­ã‚¤\nfirebase deploy\n(5åˆ†);
  else (no)
    :ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³\nâ†’ TechLead;
    stop
  endif

  :ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯\n(5å›ãƒªãƒˆãƒ©ã‚¤);

  if (ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ?) then (yes)
    :Git commit;
  else (no)
    :è‡ªå‹•Rollbackå®Ÿè¡Œ;
    :ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³\nâ†’ CTO;
    stop
  endif

  :JSONå‡ºåŠ›ç”Ÿæˆ;

end fork

|CoordinatorAgent|

:å…¨Worktreeã®çµæœã‚’åé›†;

:æˆåŠŸã—ãŸWorktreeã‚’mainã«ãƒãƒ¼ã‚¸;
note right
  **ãƒãƒ¼ã‚¸æˆ¦ç•¥**
  1. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒã‚§ãƒƒã‚¯
  2. è‡ªå‹•ãƒãƒ¼ã‚¸ (ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãªã—)
  3. æ‰‹å‹•ãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚ã‚Š)
end note

:çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ;

if (çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ?) then (yes)
  :Worktreeå‰Šé™¤\ngit worktree remove;

  :ExecutionReportç”Ÿæˆ;
  note right
    {
      "sessionId": "session-1759552488828",
      "totalTasks": 3,
      "completed": 3,
      "failed": 0,
      "successRate": 100.0,
      "totalDurationMs": 120000
    }
  end note

  :ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜\n.ai/parallel-reports/;

else (no)
  :Worktreeä¿æŒ\n(ãƒ‡ãƒãƒƒã‚°ç”¨);

  :ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ;

  :å¤±æ•—ã‚¿ã‚¹ã‚¯ã®ã¿å†å®Ÿè¡Œ;

endif

stop

legend right
  |= Worktreeæˆ¦ç•¥ |= ãƒ¡ãƒªãƒƒãƒˆ |
  | ç‹¬ç«‹ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæœ€å°åŒ– |
  | ãƒ–ãƒ©ãƒ³ãƒå®Œå…¨åˆ†é›¢ | ä¸¦åˆ—å®Ÿè¡Œã®çœŸã®å®Ÿç¾ |
  | ç°¡å˜ãªãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | Worktreeå˜ä½ã§ç ´æ£„å¯èƒ½ |
  | ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ | å„Worktreeã§ç‹¬ç«‹ã—ãŸãƒ­ã‚° |
  | ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ | Worktreeæ•°ã«åˆ¶é™ãªã— |

  **ä¸¦è¡Œåº¦ã®èª¿æ•´**
  - ä½ã‚¹ãƒšãƒƒã‚¯ãƒã‚·ãƒ³: concurrency=1
  - é€šå¸¸ãƒã‚·ãƒ³: concurrency=2-3
  - é«˜ã‚¹ãƒšãƒƒã‚¯ãƒã‚·ãƒ³: concurrency=5

  **Worktreeç®¡ç†**
  git worktree list        # ä¸€è¦§è¡¨ç¤º
  git worktree remove PATH # å‰Šé™¤
  git worktree prune       # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
endlegend

@enduml
